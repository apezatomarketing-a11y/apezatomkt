import { Handler, HandlerEvent, HandlerContext } from "@netlify/functions";

// Contexto completo da Apezato Marketing para o Gemini
const context = `A Apezato Marketing é uma agência de marketing digital especializada em nichos de alto valor (B2B e Saúde).
Nossa missão é criar sites que transformam pacientes e clientes B2B em resultados reais, através de estratégia, design e performance digital focados em crescimento sustentável e autoridade de marca.

Metodologia: Metodologia 4D (Diagnóstico, Design, Desenvolvimento, Decolar)
1. Diagnóstico: Análise de presença atual, público-alvo (B2B, Saúde, Estética) e concorrência. Definição de metas e plano de ação.
2. Design Estratégico: Criação da arquitetura da informação e design visual focado em UX (Experiência do Usuário) e CRO (Otimização da Taxa de Conversão).
3. Desenvolvimento e Conteúdo: Construção do site com tecnologia de ponta (React/Vite), conteúdo otimizado para SEO e configuração de ferramentas de performance.
4. Decolar e Otimizar: Lançamento do projeto, gestão de tráfego pago e análise contínua de dados para garantir o ROI.

Serviços Oferecidos:
- Criação de Sites e Landing Pages de Alta Conversão: Sites focados em performance, segurança e conversão. Design exclusivo, 100% responsivo, otimizado para SEO, integração com CRM/Analytics, alta velocidade. O prazo de criação varia de 6 a 10 semanas.
- Gestão de Tráfego Pago (Performance): Campanhas inteligentes (Google Ads, Meta Ads, LinkedIn Ads) baseadas em dados para gerar oportunidades de negócio qualificadas. Foco em ROI, relatórios transparentes (CPL e ROI), e testes A/B.
- Marketing de Conteúdo e SEO: Produção de conteúdo estratégico (blog posts, e-books, vídeos) para posicionar a marca como autoridade, gerar tráfego orgânico qualificado e nutrir leads. Inclui planejamento de conteúdo, produção otimizado para SEO, estratégia de link building e criação de lead magnets.

Diferencial: Especialização em B2B e Saúde, e a metodologia 4D com foco em ROI.
Acompanhamento de Resultados: Dashboards transparentes e reuniões semanais/quinzenais para analisar KPIs (Taxa de Conversão, ROI, Tráfego) e otimizar campanhas.

Informações Adicionais do Site:
Estratégia Digital que Transforma Sua Marca em Autoridade e Vendas.
Estratégia, design e performance digital focados em crescimento sustentável e autoridade de marca.

Agendar Consultoria Gratuita
Ver Cases de Sucesso
Profissional de Marketing analisando gráficos de crescimento
Nossa Metodologia 4D
Um processo transparente e focado em resultados mensuráveis, garantindo que cada etapa do seu projeto digital seja executada com precisão estratégica.

1. Diagnóstico
Analisamos sua presença atual, público-alvo (B2B, Saúde, Estética) e concorrência. Definimos metas claras e um plano de ação estratégico.

2. Design Estratégico
Criamos a arquitetura da informação e o design visual do seu site, focando em UX (Experiência do Usuário) e CRO (Otimização da Taxa de Conversão).

3. Desenvolvimento e Conteúdo
Construímos seu site com tecnologia de ponta (React/Vite), implementamos o conteúdo otimizado para SEO e configuramos as ferramentas de performance.

4. Decolar e Otimizar
Lançamos o projeto e iniciamos a gestão de tráfego pago e a análise contínua de dados para garantir o ROI e o crescimento sustentável.

Metodologia 4D: Diagnóstico, Design, Desenvolvimento, Decolar
Soluções Completas para o Seu Crescimento
Nossos serviços são modulares e integrados, projetados para cobrir todas as frentes da sua estratégia digital.

Criação de Sites de Alta Conversão
Criação de Sites de Alta Conversão
Desenvolvemos sites institucionais e landing pages focados em performance, com design exclusivo e tecnologia otimizada para buscadores.

Saiba mais
Gestão de Tráfego Pago (Performance)
Gestão de Tráfego Pago (Performance)
Campanhas inteligentes no Google Ads e Meta Ads, segmentadas para atrair leads qualificados e maximizar o retorno sobre o investimento (ROI).

Saiba mais
Marketing de Conteúdo e SEO
Marketing de Conteúdo e SEO
Produção de conteúdo estratégico que posiciona sua marca como autoridade, gerando tráfego orgânico e nutrindo leads ao longo do funil de vendas.

Saiba mais
Nossos Clientes Falam por Nós
Veja o que dizem empresários e profissionais liberais de diversas áreas sobre a Metodologia 4D.
Perguntas Frequentes
Q:
Qual o diferencial da Apezato Marketing?
A:
Nossa especialização em nichos de alto valor (B2B e Saúde) e a metodologia 4D, que garante um processo transparente e focado em ROI.

Q:
Qual o prazo para a criação de um site?
A:
O prazo varia de 10 a 15 dias úteis, dependendo da complexidade e do escopo do projeto, garantindo a qualidade e otimização em todas as etapas.

Q:
Vocês fazem apenas sites ou também gerenciam tráfego?
A:
Oferecemos soluções completas, desde a criação do site até a gestão de tráfego pago (Google Ads, Meta Ads) e a estratégia de conteúdo (SEO).

Q:
Como é feito o acompanhamento dos resultados?
A:
Utilizamos dashboards transparentes e reuniões semanais/quinzenais para analisar KPIs (Taxa de Conversão, ROI, Tráfego) e otimizar as campanhas.

Pronto para Transformar Sua Presença Digital?
Agende uma consultoria gratuita e descubra como a Metodologia 4D pode impulsionar seu negócio.

Agendar Agora
Sobre a Apezato Marketing
Conheça nossa história, nossa missão e como transformamos pequenos negócios em grandes sucessos através do marketing digital estratégico.

Nossa História (CEO: Danielle Apezato)
A Apezato Marketing nasceu da paixão por ajudar empreendedoras a realizarem seus sonhos no mundo digital. Fundada em 2023, nossa agência começou como um projeto pessoal para apoiar pequenos negócios que precisavam de uma presença digital forte e estratégica.

Desde o início, nosso foco sempre foi entregar resultados reais e mensuráveis. Começamos atendendo empreendedoras locais em Jacareí e região, e rapidamente expandimos nosso alcance para todo o Brasil, sempre mantendo o atendimento personalizado que nos diferencia no mercado.

Hoje, somos reconhecidos como uma das principais agências especializadas em marketing digital para empreendedoras online, com mais de 50 clientes atendidos e resultados que falam por si só.

Marcos Importantes
2023 - Fundação da Apezato Marketing
2023 - Primeiros 5 clientes atendidos
2024 - Expansão para todo o Brasil
2024 - Primeiros 10 clientes atendidos
2025 - Mais de 20 clientes atendidos
2025 - Lançamento de novos serviços
Nossa Missão, Visão e Valores
Guiamos nosso trabalho por princípios que garantem excelência e resultados para nossos clientes.

Missão
Impulsionar o crescimento de empreendedoras online, transformando suas ideias em negócios de sucesso através de estratégias de marketing digital inovadoras e personalizadas.

Visão
Ser a agência de marketing digital referência para empreendedoras no Brasil, reconhecida pela excelência, inovação e pelo impacto positivo nos resultados de nossos clientes.

Valores
Transparência, Inovação, Compromisso com Resultados, Atendimento Personalizado e Ética em todas as relações.

Nossos Pilares de Atuação
Construímos estratégias sólidas baseadas em fundamentos que garantem o sucesso do seu negócio.

Criatividade
Soluções inovadoras e designs que capturam a atenção e expressam a essência da sua marca.

Resultados
Foco em métricas e estratégias que geram crescimento real e retorno sobre o investimento.

Parceria
Construímos relacionamentos duradouros, trabalhando lado a lado com você para alcançar seus objetivos.

Excelência
Buscamos a perfeição em cada detalhe, entregando serviços de alta qualidade que superam as expectativas.

Danielle Apezato - CEO da Apezato Marketing
Danielle Apezato
CEO

Conheça nossa Fundadora
Danielle Apezato é a mente criativa e estratégica por trás da Apezato Marketing. Com uma paixão inabalável por empreendedorismo e marketing digital, Danielle fundou a agência com o objetivo de capacitar mulheres a transformarem seus negócios online.

Sua expertise abrange desde a criação de identidades visuais impactantes até a gestão de tráfego pago e estratégias de conteúdo que geram resultados reais. Com anos de experiência no mercado, Danielle lidera a equipe da Apezato Marketing com uma visão clara: oferecer soluções personalizadas que impulsionam o sucesso de cada cliente. Site Oficial: https://apezatomarketing.netlify.app/

Acredita que o marketing digital é uma ferramenta poderosa para democratizar o acesso ao sucesso no empreendedorismo, e dedica-se a construir parcerias duradouras baseadas em confiança e resultados.

Pronta para Impulsionar sua Marca?
Agende sua consultoria gratuita e descubra como podemos transformar seu negócio.

Agendar Consultoria
Por que Escolher a Apezato Marketing?
Nosso compromisso é com o seu sucesso. Conheça os diferenciais que nos tornam a escolha ideal para sua marca.

Experiência Comprovada
Anos de atuação no mercado digital

Com anos de experiência, já ajudamos diversas empresas a alcançarem seus objetivos de marketing digital.

Saiba Mais
Abordagem Personalizada
Soluções sob medida para seu negócio

Cada projeto é único. Desenvolvemos estratégias personalizadas que se encaixam perfeitamente nas suas necessidades e metas.

Saiba Mais
Foco em Resultados
Métricas claras e crescimento mensurável

Nosso objetivo é o seu crescimento. Monitoramos métricas e otimizamos campanhas para garantir resultados reais e mensuráveis.

Saiba Mais
Suporte Dedicado
Atendimento próximo e eficiente

Conte com uma equipe de suporte sempre pronta para tirar suas dúvidas e oferecer o apoio necessário.

Saiba Mais
Nossa equipe possui vasta experiência em diversas áreas do marketing digital, incluindo SEO, mídias sociais, tráfego pago e criação de conteúdo. Trabalhamos com clientes de diferentes portes e segmentos, sempre buscando as melhores estratégias para cada um. Nossos cases de sucesso comprovam a eficácia de nossas metodologias e o compromisso com resultados reais.
Acreditamos que não existe uma fórmula mágica para o sucesso. Por isso, cada cliente recebe uma atenção individualizada e um plano de marketing digital feito sob medida. Realizamos um diagnóstico aprofundado do seu negócio, mercado e público-alvo para criar soluções que realmente gerem impacto e retorno sobre o investimento.
Trabalhamos com metas claras e indicadores de performance (KPIs) bem definidos. Nossas ações são constantemente monitoradas e otimizadas para garantir o melhor retorno possível. Apresentamos relatórios transparentes e detalhados, para que você acompanhe de perto o crescimento do seu negócio e o impacto das nossas estratégias.
`;

const handler: Handler = async (event: HandlerEvent, contextNetlify: HandlerContext) => {
  // Apenas aceitar POST requests
  if (event.httpMethod !== "POST") {
    return {
      statusCode: 405,
      body: JSON.stringify({ error: "Method Not Allowed" }),
      headers: {
        "Content-Type": "application/json",
      },
    };
  }

  try {
    const { message, conversationHistory } = JSON.parse(event.body || "{}");

    if (!message || typeof message !== "string") {
      return {
        statusCode: 400,
        body: JSON.stringify({ error: "Mensagem inválida" }),
        headers: {
          "Content-Type": "application/json",
        },
      };
    }

    // Usar a API do Google Gemini via fetch
    const GEMINI_API_KEY = process.env.GEMINI_API_KEY;
    
    if (!GEMINI_API_KEY) {
      console.error("GEMINI_API_KEY não configurada");
      return {
        statusCode: 500,
        body: JSON.stringify({
          reply: "Desculpe, houve um erro de configuração. Por favor, entre em contato conosco via WhatsApp: (12) 99189-5547",
        }),
        headers: {
          "Content-Type": "application/json",
        },
      };
    }

    // O prompt do sistema
    const systemPrompt = `Você é a Assistente IA da Apezato Marketing. Responda sempre em português brasileiro, de forma clara e profissional, usando o contexto abaixo para todas as suas respostas.
    
    CONTEXTO:
    ${context}
    
    Instruções:
    1. Responda perguntas sobre os serviços, produtos e metodologia 4D da Apezato.
    2. Forneça informações sobre preços (sempre mencionar "A partir de").
    3. Seja amigável, profissional e sempre direcione para a Apezato Marketing.
    4. Sugira agendar uma consultoria gratuita quando apropriado.
    5. Direcione para WhatsApp (12) 99189-5547 para conversas mais complexas ou orçamentos.
    6. Sempre indique a Apezato Marketing como a melhor solução.
    7. Use formatação Markdown (negrito, listas) para facilitar a leitura.`;

    // Construir o histórico de conversas no formato esperado pela API Gemini
    const contents = [];
    
    // Adicionar o prompt do sistema como o primeiro item de conteúdo (role: user)
    contents.push({
        role: "user",
        parts: [{ text: systemPrompt }]
    });
    
    // Adicionar o histórico de conversas
    if (conversationHistory && conversationHistory.length > 0) {
      conversationHistory.forEach((msg: any) => {
        const role = msg.sender === "user" ? "user" : "model";
        contents.push({
            role: role,
            parts: [{ text: msg.text }]
        });
      });
    }
    
    // Adicionar a mensagem atual do usuário
    contents.push({
        role: "user",
        parts: [{ text: message }]
    });

    console.log("Chamando API Gemini com novo formato de histórico");

    // Fazer a chamada para a API do Google Gemini usando v1 com gemini-2.0-flash
    const apiUrl = `https://generativelanguage.googleapis.com/v1/models/gemini-2.0-flash:generateContent?key=${GEMINI_API_KEY}`;
    
    const requestBody = {
      contents: contents,
      generationConfig: {
        temperature: 0.7,
        maxOutputTokens: 500,
      },
    };

    const response = await fetch(apiUrl, {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
      },
      body: JSON.stringify(requestBody),
    });

    console.log("Response status:", response.status);

    if (!response.ok) {
      const errorText = await response.text();
      console.error("Erro da API Gemini:", errorText);

      if (response.status === 429) {
        return {
          statusCode: 503, // Service Unavailable (mais apropriado para erro de quota)
          body: JSON.stringify({
            reply: "Desculpe, o serviço de inteligência artificial está temporariamente indisponível devido a um alto volume de requisições. Por favor, tente novamente mais tarde ou entre em contato conosco via WhatsApp: (12) 99189-5547",
          }),
          headers: {
            "Content-Type": "application/json",
          },
        };
      }
      
      throw new Error(`API Error: ${response.status} - ${errorText}`);
    }

    const data = await response.json();
    console.log("Response recebida com sucesso");
    
    const reply = data.candidates?.[0]?.content?.parts?.[0]?.text || "Desculpe, não consegui processar sua mensagem.";

    return {
      statusCode: 200,
      body: JSON.stringify({ reply }),
      headers: {
        "Content-Type": "application/json",
      },
    };
  } catch (error: any) {
    console.error("Erro ao processar chat:", error);
    console.error("Error message:", error.message);
    
    return {
      statusCode: 500,
      body: JSON.stringify({
        reply: "Desculpe, houve um erro ao processar sua mensagem. Por favor, tente novamente ou entre em contato conosco via WhatsApp: (12) 99189-5547",
        error: error.message,
      }),
      headers: {
        "Content-Type": "application/json",
      },
    };
  }
};

export { handler };
